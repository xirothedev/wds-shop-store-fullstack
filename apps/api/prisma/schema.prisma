generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions", "views"]
  binaryTargets   = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique @db.VarChar(255)
  password      String?
  fullName      String?   @db.VarChar(100)
  phone         String?   @db.VarChar(15)
  avatar        String?
  role          UserRole  @default(CUSTOMER)
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  cart          Cart?
  orders        Order[]
  sessions      Session[]

  @@map("users")
}

model Session {
  id           String        @id @default(cuid())
  token        String        @unique
  refreshToken String?       @unique
  userId       String
  ipAddress    String?       @db.VarChar(45)
  userAgent    String?
  status       SessionStatus @default(ACTIVE)
  expiresAt    DateTime
  revokedAt    DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
  @@map("sessions")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  size      String  @db.VarChar(10)
  quantity  Int     @default(1)
  cart      Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])
  @@unique([cartId, productId, size])
  @@index([cartId])
  @@map("cart_items")
}

model Order {
  id                 String              @id @default(cuid())
  code               String              @unique
  userId             String
  status             OrderStatus         @default(PENDING)
  paymentStatus      PaymentStatus       @default(PENDING)
  totalAmount        Decimal             @db.Money
  shippingFee        Decimal             @default(0) @db.Money
  discountValue      Decimal             @default(0) @db.Money
  shippingAddress    String?
  shippingCity       String?             @db.VarChar(100)
  shippingState      String?             @db.VarChar(100)
  shippingZip        String?             @db.VarChar(10)
  shippingCountry    String?             @db.VarChar(100)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  items              OrderItem[]
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentTransaction PaymentTransaction?

  @@map("orders")
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  productId   String?
  productSlug String   @db.VarChar(255)
  productName String   @db.VarChar(255)
  size        String   @db.VarChar(10)
  price       Decimal  @db.Money
  quantity    Int
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product     Product? @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

model PaymentTransaction {
  id              String                   @id @default(cuid())
  orderId         String                   @unique
  transactionCode String                   @unique
  amount          Decimal                  @db.Money
  status          PaymentTransactionStatus @default(PENDING)
  paymentUrl      String?
  payosData       Json?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  order           Order                    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment_transactions")
}

model Product {
  id            String             @id @default(cuid())
  slug          String             @unique @db.VarChar(255)
  name          String             @db.VarChar(255)
  description   String
  priceCurrent  Decimal            @db.Money
  priceOriginal Decimal?           @db.Money
  priceDiscount Decimal?           @db.Money
  badge         String?            @db.VarChar(50)
  ratingValue   Decimal            @default(0) @db.Decimal(3, 2)
  ratingCount   Int                @default(0)
  isPublished   Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  gender        ProductGender      @default(UNISEX)
  cartItems     CartItem[]
  orderItems    OrderItem[]
  sizeStocks    ProductSizeStock[]

  @@index([slug])
  @@index([gender])
  @@index([isPublished])
  @@map("products")
}

/// *
///  * Manage stock by size
model ProductSizeStock {
  id        String  @id @default(cuid())
  size      String  @db.VarChar(10)
  stock     Int     @default(0)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, size])
  @@index([productId])
  @@map("product_size_stocks")
}

enum UserRole {
  CUSTOMER
  ADMIN
}

enum SessionStatus {
  ACTIVE
  INACTIVE
  REVOKED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentTransactionStatus {
  PENDING
  PAID
  CANCELLED
  EXPIRED
  FAILED
}

enum ProductGender {
  MALE
  FEMALE
  UNISEX
}
